<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Eingabe & Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .status-message {
        transition: opacity 0.3s ease;
      }
      .loading-spinner {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .content-section {
        transition: all 0.3s ease;
      }
      .status-badge {
        transition: all 0.2s ease;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-6">
    <!-- Status Message Container -->
    <div id="status-container" class="max-w-3xl mx-auto mb-4"></div>

    <!-- Content Input Section -->
    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <img src="https://anyever.de/wp-content/themes/anyever/static/images/logo-anyever-gold.svg" alt="Any Ever Logo" class="h-12" />
      </div>
      <h1 class="text-2xl font-bold mb-4">Content-Eingabe</h1>

      <input type="text" id="thema" class="border p-2 mb-4 w-full rounded" placeholder="Thema (Pflichtfeld)" required />
      <input type="text" id="subline" class="border p-2 mb-4 w-full rounded" placeholder="Subline (optional)" />
      <input type="url" id="url" class="border p-2 mb-4 w-full rounded" placeholder="Ziel-URL (optional)" />
      <input type="url" id="grafik_url" class="border p-2 mb-4 w-full rounded" placeholder="Grafik-URL (optional)" />

      <button id="submit-btn" onclick="submitInputWithValidation()" class="bg-green-600 text-white px-4 py-2 rounded-xl shadow hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
        Inhalt übermitteln
      </button>
    </div>

    <!-- Content Review Section -->
    <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow p-6">
      <h1 class="text-2xl font-bold mb-4">Content Review & Freigabe</h1>

      <div class="mb-4 flex gap-2">
        <input type="text" id="input_id" class="border p-2 flex-1 bg-gray-100 rounded" placeholder="input_id" readonly />
        <button onclick="manualLoadReview()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
          Manuell laden
        </button>
      </div>

      <!-- Fixed Content Sections (Schema-korrigiert) -->
      <div id="linkedin-section" class="content-section mb-4 p-4 border border-gray-200 rounded-lg" style="display: none;">
        <div class="flex items-center justify-between mb-2">
          <label class="font-semibold text-lg">LinkedIn Text:</label>
          <span class="status-badge px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Pending</span>
        </div>
        <textarea id="linkedin_text" class="border w-full p-2 mt-1 min-h-[100px] rounded"></textarea>
        <select id="linkedin_status" class="mt-2 p-2 border w-full rounded">
          <option value="pending">Auswahl treffen</option>
          <option value="yes">Freigeben</option>
          <option value="no">Ablehnen</option>
        </select>
      </div>

      <div id="instagram-section" class="content-section mb-4 p-4 border border-gray-200 rounded-lg" style="display: none;">
        <div class="flex items-center justify-between mb-2">
          <label class="font-semibold text-lg">Instagram Text:</label>
          <span class="status-badge px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Pending</span>
        </div>
        <textarea id="insta_text" class="border w-full p-2 mt-1 min-h-[100px] rounded"></textarea>
        <select id="insta_status" class="mt-2 p-2 border w-full rounded">
          <option value="pending">Auswahl treffen</option>
          <option value="yes">Freigeben</option>
          <option value="no">Ablehnen</option>
        </select>
      </div>

      <div id="facebook-section" class="content-section mb-4 p-4 border border-gray-200 rounded-lg" style="display: none;">
        <div class="flex items-center justify-between mb-2">
          <label class="font-semibold text-lg">Facebook Text:</label>
          <span class="status-badge px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Pending</span>
        </div>
        <textarea id="facebook_text" class="border w-full p-2 mt-1 min-h-[100px] rounded"></textarea>
        <select id="facebook_status" class="mt-2 p-2 border w-full rounded">
          <option value="pending">Auswahl treffen</option>
          <option value="yes">Freigeben</option>
          <option value="no">Ablehnen</option>
        </select>
      </div>

      <div id="blog-section" class="content-section mb-4 p-4 border border-gray-200 rounded-lg" style="display: none;">
        <div class="flex items-center justify-between mb-2">
          <label class="font-semibold text-lg">Blog Text:</label>
          <span class="status-badge px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">Pending</span>
        </div>
        <textarea id="blog_text" class="border w-full p-2 mt-1 min-h-[100px] rounded"></textarea>
        <select id="blog_status" class="mt-2 p-2 border w-full rounded">
          <option value="pending">Auswahl treffen</option>
          <option value="yes">Freigeben</option>
          <option value="no">Ablehnen</option>
        </select>
      </div>

      <button id="review-submit-btn" onclick="submitReview()" class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700" style="display: none;">
        Freigaben speichern
      </button>
    </div>

    <script>
      // Global Variables
      const inputId = Date.now().toString();
      let pollInterval = null;
      let isPolling = false;

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("input_id").value = inputId;
        // KEIN automatisches loadReview() beim Start!
      });

      // Content Type Configuration mit korrigierten Schema-Namen
      const CONTENT_MAPPING = {
        linkedin_text: 'linkedin_text',        // Frontend → Backend
        linkedin_status: 'linkedin_status',
        insta_text: 'insta_feed_text',         // Frontend → Backend (korrigiert!)
        insta_status: 'insta_feed_status',     // Frontend → Backend (korrigiert!)  
        facebook_text: 'facebook_text',
        facebook_status: 'facebook_status',
        blog_text: 'blog_text',
        blog_status: 'blog_status'
      };

      // Enhanced Validation & Submission
      async function submitInputWithValidation() {
        const thema = document.getElementById("thema").value.trim();
        if (!thema) {
          showErrorMessage("Bitte füllen Sie das Thema-Feld aus.");
          return;
        }

        const payload = {
          input_id: inputId,
          thema: thema,
          subline: document.getElementById("subline").value,
          url: document.getElementById("url").value,
          grafik_url: document.getElementById("grafik_url").value,
        };

        await executeSubmission(payload);
      }

      async function executeSubmission(payload) {
        const webhookUrl = "https://hook.eu2.make.com/cv9u4q1t3exjr6wz196owrm4ud6atahl";

        try {
          showLoadingState(true);
          showProgressMessage("Content wird generiert...");
          
          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (response.ok) {
            showSuccessMessage("Erfolgreich gestartet! ✅");
            showInfoMessage("⏱️ Generation läuft ca. 2-3 Minuten. Klicken Sie dann auf 'Manuell laden'.");
            
            // KEIN automatisches Polling - nur einmaliger Check nach 3 Minuten
            setTimeout(() => {
              showInfoMessage("💡 Content sollte jetzt fertig sein. Bitte 'Manuell laden' klicken.");
            }, 180000); // 3 Minuten
            
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          console.error("Submission error:", error);
          showErrorMessage(`Fehler beim Übertragen: ${error.message}`);
        } finally {
          showLoadingState(false);
        }
      }

      // MANUELLE Load-Funktion (kein Loop!)
      async function manualLoadReview() {
        if (isPolling) {
          showWarningMessage("Bereits am Laden...");
          return;
        }

        await loadReview();
      }

      // Enhanced Load Review Function - LOOP-FREI!
      async function loadReview() {
        const inputIdValue = document.getElementById("input_id").value;
        if (!inputIdValue) return;

        isPolling = true;
        const webhookUrl = `https://hook.eu2.make.com/hw1siz7ad14nfv7tr4y0cte3l2rtkwxm?mode=load&input_id=${inputIdValue}`;

        try {
          showProgressMessage("Lade Content...");
          
          const response = await fetch(webhookUrl);
          if (!response.ok) throw new Error("Antwort fehlgeschlagen");

          const data = await response.json();
          console.log("Received data:", data); // Debug-Log
          
          let hasGeneratedContent = false;
          
          // Schema-korrigierte Zuordnung
          const contentSections = [
            {
              section: 'linkedin-section',
              textField: 'linkedin_text',
              statusField: 'linkedin_status', 
              backendText: data.linkedin_text,      // Direkte Zuordnung
              backendStatus: data.linkedin_status,
              label: 'LinkedIn'
            },
            {
              section: 'instagram-section', 
              textField: 'insta_text',
              statusField: 'insta_status',
              backendText: data.insta_feed_text,    // Backend-Schema
              backendStatus: data.insta_feed_status,
              label: 'Instagram'
            },
            {
              section: 'facebook-section',
              textField: 'facebook_text', 
              statusField: 'facebook_status',
              backendText: data.facebook_text,      // Direkte Zuordnung
              backendStatus: data.facebook_status,
              label: 'Facebook'
            },
            {
              section: 'blog-section',
              textField: 'blog_text',
              statusField: 'blog_status',
              backendText: data.blog_text,          // Direkte Zuordnung
              backendStatus: data.blog_status, 
              label: 'Blog'
            }
          ];

          contentSections.forEach(config => {
            const hasContent = config.backendText && config.backendText.trim() !== '';
            const sectionElement = document.getElementById(config.section);
            
            if (hasContent) {
              hasGeneratedContent = true;
              sectionElement.style.display = 'block';
              
              // Felder füllen
              document.getElementById(config.textField).value = config.backendText || "";
              document.getElementById(config.statusField).value = config.backendStatus || "pending";
              
              // Status-Badge aktualisieren
              updateSectionStatus(sectionElement, config.backendStatus);
              
              console.log(`${config.label} Content loaded:`, config.backendText.substring(0, 50) + "...");
            } else {
              sectionElement.style.display = 'none';
            }
          });
          
          document.getElementById("review-submit-btn").style.display = hasGeneratedContent ? "block" : "none";
          
          if (hasGeneratedContent) {
            showSuccessMessage("✅ Content erfolgreich geladen!");
          } else {
            showInfoMessage("Noch kein Content verfügbar. Bitte warten oder erneut versuchen.");
          }
          
        } catch (error) {
          console.error("Fehler beim Laden der Review-Daten", error);
          showErrorMessage("Fehler beim Laden der Daten. Bitte versuchen Sie es erneut.");
        } finally {
          isPolling = false;
        }
      }

      function updateSectionStatus(sectionDiv, status) {
        const statusBadge = sectionDiv.querySelector('.status-badge');
        if (statusBadge) {
          const statusConfig = {
            'pending': { text: 'Pending', class: 'bg-yellow-100 text-yellow-800' },
            'yes': { text: 'Freigegeben', class: 'bg-green-100 text-green-800' },
            'no': { text: 'Abgelehnt', class: 'bg-red-100 text-red-800' }
          };
          
          const config = statusConfig[status] || statusConfig['pending'];
          statusBadge.textContent = config.text;
          statusBadge.className = `status-badge px-3 py-1 rounded-full text-sm font-medium ${config.class}`;
        }
      }

      // Submit Review Function
      async function submitReview() {
        const payload = {
          input_id: document.getElementById("input_id").value,
          mode: "save",
          linkedin_text: document.getElementById("linkedin_text").value,
          linkedin_status: document.getElementById("linkedin_status").value,
          insta_text: document.getElementById("insta_text").value,
          insta_status: document.getElementById("insta_status").value,
          facebook_text: document.getElementById("facebook_text").value,
          facebook_status: document.getElementById("facebook_status").value,
          blog_text: document.getElementById("blog_text").value,
          blog_status: document.getElementById("blog_status").value,
        };

        const webhookUrl = "https://hook.eu2.make.com/hw1siz7ad14nfv7tr4y0cte3l2rtkwxm";

        try {
          showLoadingState(true, "review-submit-btn");
          
          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (response.ok) {
            showSuccessMessage("Freigaben erfolgreich gespeichert ✅");
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (error) {
          console.error("Review submission error:", error);
          showErrorMessage(`Fehler beim Speichern: ${error.message}`);
        } finally {
          showLoadingState(false, "review-submit-btn");
        }
      }

      // UI Helper Functions
      function showLoadingState(isLoading, buttonId = "submit-btn") {
        const button = document.getElementById(buttonId);
        if (button) {
          button.disabled = isLoading;
          if (isLoading) {
            button.innerHTML = '<div class="loading-spinner"></div>Wird verarbeitet...';
          } else {
            button.innerHTML = buttonId === "submit-btn" ? "Inhalt übermitteln" : "Freigaben speichern";
          }
        }
      }

      function showStatusMessage(message, type) {
        const container = document.getElementById("status-container");
        
        // Remove existing message
        const existing = container.querySelector('.status-message');
        if (existing) existing.remove();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'status-message p-4 rounded-lg font-medium text-center';
        
        const styles = {
          info: 'bg-blue-50 text-blue-800 border border-blue-200',
          success: 'bg-green-50 text-green-800 border border-green-200',
          error: 'bg-red-50 text-red-800 border border-red-200',
          warning: 'bg-yellow-50 text-yellow-800 border border-yellow-200'
        };
        
        messageDiv.className += ` ${styles[type] || styles.info}`;
        messageDiv.textContent = message;
        
        container.appendChild(messageDiv);
        
        // Auto-hide success/info messages
        if (type === 'success' || type === 'info') {
          setTimeout(() => {
            messageDiv.style.opacity = '0';
            setTimeout(() => messageDiv.remove(), 300);
          }, 8000);
        }
      }

      function showProgressMessage(message) { showStatusMessage(message, 'info'); }
      function showSuccessMessage(message) { showStatusMessage(message, 'success'); }
      function showErrorMessage(message) { showStatusMessage(message, 'error'); }
      function showWarningMessage(message) { showStatusMessage(message, 'warning'); }
      function showInfoMessage(message) { showStatusMessage(message, 'info'); }

      // Legacy functions for backward compatibility
      function submitInput() {
        submitInputWithValidation();
      }
    </script>
  </body>
</html>